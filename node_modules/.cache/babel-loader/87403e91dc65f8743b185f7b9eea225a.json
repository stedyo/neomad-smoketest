{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.commitServerChanges = commitServerChanges;\nexports.defaultState = defaultState;\nexports.estimateAttribute = estimateAttribute;\nexports.estimateAttributes = estimateAttributes;\nexports.mergeFirstPendingState = mergeFirstPendingState;\nexports.popPendingState = popPendingState;\nexports.pushPendingState = pushPendingState;\nexports.setPendingOp = setPendingOp;\nexports.setServerData = setServerData;\n\nvar _encode = _interopRequireDefault(require(\"./encode\"));\n\nvar _ParseFile = _interopRequireDefault(require(\"./ParseFile\"));\n\nvar _ParseObject = _interopRequireDefault(require(\"./ParseObject\"));\n\nvar _ParseRelation = _interopRequireDefault(require(\"./ParseRelation\"));\n\nvar _TaskQueue = _interopRequireDefault(require(\"./TaskQueue\"));\n\nvar _ParseOp = require(\"./ParseOp\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    enumerableOnly && (symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    })), keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = null != arguments[i] ? arguments[i] : {};\n    i % 2 ? ownKeys(Object(source), !0).forEach(function (key) {\n      _defineProperty(target, key, source[key]);\n    }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) {\n      Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n    });\n  }\n\n  return target;\n}\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nfunction defaultState()\n/*: State*/\n{\n  return {\n    serverData: {},\n    pendingOps: [{}],\n    objectCache: {},\n    tasks: new _TaskQueue.default(),\n    existed: false\n  };\n}\n\nfunction setServerData(serverData\n/*: AttributeMap*/\n, attributes\n/*: AttributeMap*/\n) {\n  for (const attr in attributes) {\n    if (typeof attributes[attr] !== 'undefined') {\n      serverData[attr] = attributes[attr];\n    } else {\n      delete serverData[attr];\n    }\n  }\n}\n\nfunction setPendingOp(pendingOps\n/*: Array<OpsMap>*/\n, attr\n/*: string*/\n, op\n/*: ?Op*/\n) {\n  const last = pendingOps.length - 1;\n\n  if (op) {\n    pendingOps[last][attr] = op;\n  } else {\n    delete pendingOps[last][attr];\n  }\n}\n\nfunction pushPendingState(pendingOps\n/*: Array<OpsMap>*/\n) {\n  pendingOps.push({});\n}\n\nfunction popPendingState(pendingOps\n/*: Array<OpsMap>*/\n)\n/*: OpsMap*/\n{\n  const first = pendingOps.shift();\n\n  if (!pendingOps.length) {\n    pendingOps[0] = {};\n  }\n\n  return first;\n}\n\nfunction mergeFirstPendingState(pendingOps\n/*: Array<OpsMap>*/\n) {\n  const first = popPendingState(pendingOps);\n  const next = pendingOps[0];\n\n  for (const attr in first) {\n    if (next[attr] && first[attr]) {\n      const merged = next[attr].mergeWith(first[attr]);\n\n      if (merged) {\n        next[attr] = merged;\n      }\n    } else {\n      next[attr] = first[attr];\n    }\n  }\n}\n\nfunction estimateAttribute(serverData\n/*: AttributeMap*/\n, pendingOps\n/*: Array<OpsMap>*/\n, className\n/*: string*/\n, id\n/*: ?string*/\n, attr\n/*: string*/\n)\n/*: mixed*/\n{\n  let value = serverData[attr];\n\n  for (let i = 0; i < pendingOps.length; i++) {\n    if (pendingOps[i][attr]) {\n      if (pendingOps[i][attr] instanceof _ParseOp.RelationOp) {\n        if (id) {\n          value = pendingOps[i][attr].applyTo(value, {\n            className: className,\n            id: id\n          }, attr);\n        }\n      } else {\n        value = pendingOps[i][attr].applyTo(value);\n      }\n    }\n  }\n\n  return value;\n}\n\nfunction estimateAttributes(serverData\n/*: AttributeMap*/\n, pendingOps\n/*: Array<OpsMap>*/\n, className\n/*: string*/\n, id\n/*: ?string*/\n)\n/*: AttributeMap*/\n{\n  const data = {};\n\n  for (var attr in serverData) {\n    data[attr] = serverData[attr];\n  }\n\n  for (let i = 0; i < pendingOps.length; i++) {\n    for (attr in pendingOps[i]) {\n      if (pendingOps[i][attr] instanceof _ParseOp.RelationOp) {\n        if (id) {\n          data[attr] = pendingOps[i][attr].applyTo(data[attr], {\n            className: className,\n            id: id\n          }, attr);\n        }\n      } else {\n        if (attr.includes('.')) {\n          // convert a.b.c into { a: { b: { c: value } } }\n          const fields = attr.split('.');\n          const first = fields[0];\n          const last = fields[fields.length - 1];\n          data[first] = _objectSpread({}, serverData[first]);\n\n          let object = _objectSpread({}, data);\n\n          for (let i = 0; i < fields.length - 1; i++) {\n            const key = fields[i];\n\n            if (!(key in object)) {\n              object[key] = {};\n            }\n\n            object = object[key];\n          }\n\n          object[last] = pendingOps[i][attr].applyTo(object[last]);\n        } else {\n          data[attr] = pendingOps[i][attr].applyTo(data[attr]);\n        }\n      }\n    }\n  }\n\n  return data;\n}\n\nfunction nestedSet(obj, key, value) {\n  const path = key.split('.');\n\n  for (let i = 0; i < path.length - 1; i++) {\n    if (!(path[i] in obj)) obj[path[i]] = {};\n    obj = obj[path[i]];\n  }\n\n  if (typeof value === 'undefined') {\n    delete obj[path[path.length - 1]];\n  } else {\n    obj[path[path.length - 1]] = value;\n  }\n}\n\nfunction commitServerChanges(serverData\n/*: AttributeMap*/\n, objectCache\n/*: ObjectCache*/\n, changes\n/*: AttributeMap*/\n) {\n  for (const attr in changes) {\n    const val = changes[attr];\n    nestedSet(serverData, attr, val);\n\n    if (val && typeof val === 'object' && !(val instanceof _ParseObject.default) && !(val instanceof _ParseFile.default) && !(val instanceof _ParseRelation.default)) {\n      const json = (0, _encode.default)(val, false, true);\n      objectCache[attr] = JSON.stringify(json);\n    }\n  }\n}","map":{"version":3,"sources":["/Users/szd/Dev/ycomms-smoketest-landing-page/node_modules/parse/lib/node/ObjectStateMutations.js"],"names":["Object","defineProperty","exports","value","commitServerChanges","defaultState","estimateAttribute","estimateAttributes","mergeFirstPendingState","popPendingState","pushPendingState","setPendingOp","setServerData","_encode","_interopRequireDefault","require","_ParseFile","_ParseObject","_ParseRelation","_TaskQueue","_ParseOp","obj","__esModule","default","ownKeys","object","enumerableOnly","keys","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","_defineProperty","getOwnPropertyDescriptors","defineProperties","configurable","writable","serverData","pendingOps","objectCache","tasks","existed","attributes","attr","op","last","first","shift","next","merged","mergeWith","className","id","RelationOp","applyTo","data","includes","fields","split","nestedSet","path","changes","val","json","JSON","stringify"],"mappings":"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","sourcesContent":["\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.commitServerChanges = commitServerChanges;\nexports.defaultState = defaultState;\nexports.estimateAttribute = estimateAttribute;\nexports.estimateAttributes = estimateAttributes;\nexports.mergeFirstPendingState = mergeFirstPendingState;\nexports.popPendingState = popPendingState;\nexports.pushPendingState = pushPendingState;\nexports.setPendingOp = setPendingOp;\nexports.setServerData = setServerData;\n\nvar _encode = _interopRequireDefault(require(\"./encode\"));\n\nvar _ParseFile = _interopRequireDefault(require(\"./ParseFile\"));\n\nvar _ParseObject = _interopRequireDefault(require(\"./ParseObject\"));\n\nvar _ParseRelation = _interopRequireDefault(require(\"./ParseRelation\"));\n\nvar _TaskQueue = _interopRequireDefault(require(\"./TaskQueue\"));\n\nvar _ParseOp = require(\"./ParseOp\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n    enumerableOnly && (symbols = symbols.filter(function (sym) {\n      return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n    })), keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = null != arguments[i] ? arguments[i] : {};\n    i % 2 ? ownKeys(Object(source), !0).forEach(function (key) {\n      _defineProperty(target, key, source[key]);\n    }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) {\n      Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n    });\n  }\n\n  return target;\n}\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nfunction defaultState()\n/*: State*/\n{\n  return {\n    serverData: {},\n    pendingOps: [{}],\n    objectCache: {},\n    tasks: new _TaskQueue.default(),\n    existed: false\n  };\n}\n\nfunction setServerData(serverData\n/*: AttributeMap*/\n, attributes\n/*: AttributeMap*/\n) {\n  for (const attr in attributes) {\n    if (typeof attributes[attr] !== 'undefined') {\n      serverData[attr] = attributes[attr];\n    } else {\n      delete serverData[attr];\n    }\n  }\n}\n\nfunction setPendingOp(pendingOps\n/*: Array<OpsMap>*/\n, attr\n/*: string*/\n, op\n/*: ?Op*/\n) {\n  const last = pendingOps.length - 1;\n\n  if (op) {\n    pendingOps[last][attr] = op;\n  } else {\n    delete pendingOps[last][attr];\n  }\n}\n\nfunction pushPendingState(pendingOps\n/*: Array<OpsMap>*/\n) {\n  pendingOps.push({});\n}\n\nfunction popPendingState(pendingOps\n/*: Array<OpsMap>*/\n)\n/*: OpsMap*/\n{\n  const first = pendingOps.shift();\n\n  if (!pendingOps.length) {\n    pendingOps[0] = {};\n  }\n\n  return first;\n}\n\nfunction mergeFirstPendingState(pendingOps\n/*: Array<OpsMap>*/\n) {\n  const first = popPendingState(pendingOps);\n  const next = pendingOps[0];\n\n  for (const attr in first) {\n    if (next[attr] && first[attr]) {\n      const merged = next[attr].mergeWith(first[attr]);\n\n      if (merged) {\n        next[attr] = merged;\n      }\n    } else {\n      next[attr] = first[attr];\n    }\n  }\n}\n\nfunction estimateAttribute(serverData\n/*: AttributeMap*/\n, pendingOps\n/*: Array<OpsMap>*/\n, className\n/*: string*/\n, id\n/*: ?string*/\n, attr\n/*: string*/\n)\n/*: mixed*/\n{\n  let value = serverData[attr];\n\n  for (let i = 0; i < pendingOps.length; i++) {\n    if (pendingOps[i][attr]) {\n      if (pendingOps[i][attr] instanceof _ParseOp.RelationOp) {\n        if (id) {\n          value = pendingOps[i][attr].applyTo(value, {\n            className: className,\n            id: id\n          }, attr);\n        }\n      } else {\n        value = pendingOps[i][attr].applyTo(value);\n      }\n    }\n  }\n\n  return value;\n}\n\nfunction estimateAttributes(serverData\n/*: AttributeMap*/\n, pendingOps\n/*: Array<OpsMap>*/\n, className\n/*: string*/\n, id\n/*: ?string*/\n)\n/*: AttributeMap*/\n{\n  const data = {};\n\n  for (var attr in serverData) {\n    data[attr] = serverData[attr];\n  }\n\n  for (let i = 0; i < pendingOps.length; i++) {\n    for (attr in pendingOps[i]) {\n      if (pendingOps[i][attr] instanceof _ParseOp.RelationOp) {\n        if (id) {\n          data[attr] = pendingOps[i][attr].applyTo(data[attr], {\n            className: className,\n            id: id\n          }, attr);\n        }\n      } else {\n        if (attr.includes('.')) {\n          // convert a.b.c into { a: { b: { c: value } } }\n          const fields = attr.split('.');\n          const first = fields[0];\n          const last = fields[fields.length - 1];\n          data[first] = _objectSpread({}, serverData[first]);\n\n          let object = _objectSpread({}, data);\n\n          for (let i = 0; i < fields.length - 1; i++) {\n            const key = fields[i];\n\n            if (!(key in object)) {\n              object[key] = {};\n            }\n\n            object = object[key];\n          }\n\n          object[last] = pendingOps[i][attr].applyTo(object[last]);\n        } else {\n          data[attr] = pendingOps[i][attr].applyTo(data[attr]);\n        }\n      }\n    }\n  }\n\n  return data;\n}\n\nfunction nestedSet(obj, key, value) {\n  const path = key.split('.');\n\n  for (let i = 0; i < path.length - 1; i++) {\n    if (!(path[i] in obj)) obj[path[i]] = {};\n    obj = obj[path[i]];\n  }\n\n  if (typeof value === 'undefined') {\n    delete obj[path[path.length - 1]];\n  } else {\n    obj[path[path.length - 1]] = value;\n  }\n}\n\nfunction commitServerChanges(serverData\n/*: AttributeMap*/\n, objectCache\n/*: ObjectCache*/\n, changes\n/*: AttributeMap*/\n) {\n  for (const attr in changes) {\n    const val = changes[attr];\n    nestedSet(serverData, attr, val);\n\n    if (val && typeof val === 'object' && !(val instanceof _ParseObject.default) && !(val instanceof _ParseFile.default) && !(val instanceof _ParseRelation.default)) {\n      const json = (0, _encode.default)(val, false, true);\n      objectCache[attr] = JSON.stringify(json);\n    }\n  }\n}"]},"metadata":{},"sourceType":"script"}